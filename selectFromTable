#!/usr/bin/bash

dbName=$1
dbPath="./mydb/$dbName"

# List tables (excluding metadata)
tables=($(ls "$dbPath" | grep -v '^\.' | grep -v '\.metadata$'))
if [[ ${#tables[@]} -eq 0 ]]; then
  echo "No tables in '$dbName'."
  exit 1
fi

# Let user select a table (with a "Cancel" option)
options=( "${tables[@]}" "Cancel" )

echo "Tables in '$dbName':"
PS3="Enter your choice (1-${#options[@]}): "
select tableName in "${options[@]}"; do
  case "$tableName" in
    "Cancel")
      echo "Returning to menu."
      exit 0
      ;;
    "")
      # Out of range or non‑numeric
      echo "Invalid selection. Please try again."
      ;;
    *)
      tablePath="$dbPath/$tableName"
      metaFile="$dbPath/.${tableName}.metadata"

      if [[ ! -f "$tablePath" ]]; then
        echo "Table file '$tableName' not found. Try again."
      elif [[ ! -f "$metaFile" ]]; then
        echo "Metadata for '$tableName' not found. Try again."
      else
        # valid selection
        break
      fi
      ;;
  esac
done



# Load column names into array
metaCols=($(cut -d":" -f1 "$metaFile"))


# Show full table
echo -e "\nSelected table: $tableName"
echo "Content of Table $tableName:"

{
  echo "${metaCols[*]}" | tr ' ' ':'
  cat "$tablePath"
} | column -t -s ":"


# Loop to get valid column name or 0 to go back
while true; do
  read -p $'\nEnter column name to filter (or 0 to go back): ' col
  if [[ "$col" == "0" ]]; then
    echo "Returning to menu."
    exit 0
  fi

  if [[ -z "$col" ]]; then
  echo "No input entered. Please try again."
  continue
  fi

  idx=-1
  for i in "${!metaCols[@]}"; do
    if [[ "${metaCols[$i]}" == "$col" ]]; then
      idx=$((i+1))
      break
    fi
  done

  if [[ $idx -eq -1 ]]; then
    echo "Column '$col' not found. Try again."
  else
    break
  fi
done


  # Get column type 
  metaTypes=($(cut -d":" -f2 "$metaFile"))
  colType=${metaTypes[$((idx-1))]}

  # numeric if int
  if [[ "$colType" == "int" ]]; then
    numericCol=true
  else
    numericCol=false
    echo "Note: Type of column '$col' is '$colType'; only '=' comparisons are allowed."
  fi
 

   # Loop to search values until user choose cancel
   while true; do
    # Pick operator 
    if $numericCol; then
      echo; echo "Choose comparison operator (or Cancel to go back):"
      options=( "=" "!=" ">" "<" ">=" "<=" "Cancel" )
      PS3="Enter your choice (1-7): "
      select choice in "${options[@]}"; do
        case $REPLY in
          1) op="=="   ;;  # equality
          2) op="!="   ;;  # not‑equal
          3) op=">"    ;;  # greater
          4) op="<"    ;;  # less
          5) op=">="   ;;  # ge
          6) op="<="   ;;  # le
          7) echo "Returning to menu." ; exit 0 ;;
          *)   echo "Invalid selection. Try again." ; continue ;;
        esac
        break
      done
    else
      op="=="   # string or bool: only equality
    fi
    

     # Read the comparison value
     while true; do
       read -p "Enter value to match in '$col' with (or 0 to go back): " val
       if [[ -z "$val" ]]; then
         echo "No input entered. Please try again."
         continue
         elif [[ "$val" == "0" ]]; then
         echo "Returning to menu."
         exit 0
       fi
       break
     done


    # Check for numeric values in case of numeric column
    if $numericCol ; then 
      if ! [[ "$val" =~ ^-?[0-9]+(\.[0-9]+)?$ ]]; then
        echo "Error: '$val' is not a valid number. Try again."
        continue
      fi
    fi

     # Filtering
     result=$(awk -F":" -v c="$idx" -v v="$val" "\$c $op v" "$tablePath")

     if [[ -n "$result" ]]; then
       echo -e "\nRows where $col $op $val:"
       {
         echo "${metaCols[*]}" | tr ' ' ':'
         echo "$result"
       } | column -t -s ":"
     else
       echo "No matching records found."
     fi

   done

