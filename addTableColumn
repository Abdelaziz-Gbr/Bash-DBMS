#!/usr/bin/bash

# ━━━━━━━━━━━━[ 🎨 Color Definitions ]━━━━━━━━━━━━
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;36m'
NC='\033[0m' # No Color

# ----- Config -----
METADATA_DIR="./mydb"

# ----- Utilities -----

pause() {
    read -r -p "$(echo -e "${YELLOW}⚠️  Press any key to continue...${NC}")" -n1 -s
    echo
}

validate_column_name() {
    local name=$1

    if [[ -z "$name" ]]; then
        echo -e "${RED}❌ You must enter a column name!${NC}"
        return 1
    fi

    if [[ $(./inputValidator CHARS_ONLY "$name") != "0" ]]; then
        echo -e "${RED}❌ Column name should contain only letters (A-Z or a-z).${NC}"
        return 1
    fi

    return 0
}

choose_column_type() {
    local dbName=$1
    local tableName=$2
    local columnName=$3
    local metadataFile="$METADATA_DIR/$dbName/.$tableName.metadata"

    echo -e "${BLUE}📘 Choose the type of column '${columnName}':${NC}"
    PS3="> "
    select columnType in "INT" "BOOLEAN" "STRING"; do
        case "$columnType" in
            "INT"|"BOOLEAN"|"STRING")
                if [[ $pk -eq 0 ]] && [[ "$columnType" == "INT" || "$columnType" == "STRING" ]]; then
                    read -p $'Is this column a primary key(unique)? \ntype yes if so: ' isPrimaryKey < /dev/tty
                    if [[ "$isPrimaryKey" =~ ^[yY]([eE][sS])?$ ]]; then
                        pk=1
                        echo -e "${GREEN}✅ Column '$columnName' set as primary key.${NC}"
                        echo "$columnName:INT:1" >> "$metadataFile"
                        break
                    fi
                fi
                echo -e "${GREEN}✅ Adding column '$columnName' of type '$columnType' to table '$tableName'...${NC}"
                echo "$columnName:$columnType:0" >> "$metadataFile"
                break
                ;;
            *)
                echo -e "${YELLOW}⚠️  Invalid column type. Please choose again.${NC}"
                ;;
        esac
    done
}

create_table() {
    local metadataFile="$METADATA_DIR/$dbName/.$tableName.metadata"

    echo -e "${BLUE}━━━━━━━━━━━━[ 📘 Creating table '$tableName' in database '$dbName' ]━━━━━━━━━━━━${NC}"

    while true; do
        clear
        read -p "$(echo -e "${BLUE}📘 Enter column name (or type '0' to finish): ${NC}")" columnName < /dev/tty

        if [[ "$columnName" == "0" ]]; then
            if [[ $pk -eq 0 ]]; then
                echo -e "${RED}❌ You must define at least one primary key!${NC}"
                pause
                continue
            fi
            echo -e "${GREEN}✅ Finished creating table '$tableName'.${NC}"
            break
        fi

        if ! validate_column_name "$columnName"; then
            pause
            continue
        fi

        if ./checkForRepeatedColumnName "$dbName" "$tableName" "$columnName"; then
            echo -e "${YELLOW}⚠️  Column '$columnName' already exists in table '$tableName'. Please choose a different name.${NC}"
            pause
            continue
        fi

        choose_column_type "$dbName" "$tableName" "$columnName"
    done
}

# ----- Main Execution -----

if [[ $# -lt 2 ]]; then
    echo -e "${RED}❌ Internal error: database name or table name not provided.${NC}"
    exit 1
fi

dbName=$1
tableName=$2
pk=0

create_table
pause
clear
